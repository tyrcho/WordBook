package com.tyrcho.dictionary.view;

import java.awt.BorderLayout;
import java.awt.Component;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.HashMap;
import java.util.Map;

import javax.swing.Box;
import javax.swing.JCheckBox;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.SpringLayout;
import javax.swing.SwingUtilities;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;

import com.sun.java.util.SpringUtilities;
import com.tyrcho.dictionary.model.SessionParameters;
import com.tyrcho.dictionary.model.TwoWayDictionary;
import com.tyrcho.gui.component.JTextField;
import com.tyrcho.gui.component.TextFieldWithSlider;
import com.tyrcho.gui.toolkit.RadioButtonGroup;

public class SessionParametersPanel extends JPanel {
	private static final long serialVersionUID = 7727334170064237821L;
	private RadioButtonGroup languageButtonGroup;
	private TextFieldWithSlider questionCountField;
	private TextFieldWithSlider randomCountField;
	private TextFieldWithSlider badCountField;
	private TextFieldWithSlider recentCountField;
	private TwoWayDictionary dictionary;
	protected boolean isUpdating;
	private static SessionParametersPanel panel;

	public SessionParametersPanel(TwoWayDictionary dictionary) {
		this.dictionary = dictionary;
		init();
	}

	private void init() {
		setLayout(new BorderLayout());
		Map<String, Boolean> languages = new HashMap<String, Boolean>();
		languages.put(dictionary.getFirstLanguage(), true);
		languages.put(dictionary.getSecondLanguage(), false);
		languageButtonGroup = new RadioButtonGroup(RadioButtonGroup.VERTICAL,
				languages);
		languageButtonGroup.setCurrentValue(Boolean.FALSE);
		add(languageButtonGroup, BorderLayout.NORTH);
		add(buildPercentsFields(), BorderLayout.CENTER);
		languageButtonGroup.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				questionCountField.setMax(getMaxSize());
			}
		});
	}

	private int getMaxSize() {
		return dictionary.getEntries(
				(Boolean) languageButtonGroup.getCurrentValue()).size();
	}

	private Component buildPercentsFields() {
		JPanel jPanel = new JPanel(new SpringLayout());
		jPanel.add(new JLabel("% Erreurs"));
		jPanel.add(badCountField = new TextFieldWithSlider(0, 100, 30));
		jPanel.add(new JLabel("% Récents"));
		jPanel.add(recentCountField = new TextFieldWithSlider(0, 100, 40));
		jPanel.add(new JLabel("% Aléatoire"));
		jPanel.add(randomCountField = new TextFieldWithSlider(0, 100, 30));
		jPanel.add(new JLabel("Nombre de questions"));
		jPanel.add(questionCountField = new TextFieldWithSlider(0,
				getMaxSize(), 10));
		SpringUtilities.makeCompactGrid(jPanel, 4, 2);
		randomCountField.addChangeListener(buildPercentsChangeListener(
				randomCountField, badCountField, recentCountField));
		badCountField.addChangeListener(buildPercentsChangeListener(
				badCountField, randomCountField, recentCountField));
		recentCountField.addChangeListener(buildPercentsChangeListener(
				recentCountField, randomCountField, badCountField));
		return jPanel;
	}

	private ChangeListener buildPercentsChangeListener(
			final TextFieldWithSlider current, final TextFieldWithSlider first,
			final TextFieldWithSlider second) {
		return new ChangeListener() {
			public void stateChanged(ChangeEvent e) {
				SwingUtilities.invokeLater(new Runnable() {
					public void run() {
						final int total = current.getValue() + first.getValue()
								+ second.getValue();
						if (total > 100) {
							int diff1 = Math.min(total - 100, first.getValue());
							first.setValue(first.getValue() - diff1);
							int diff2 = total - diff1 - 100;
							if (diff2 > 0) {
								second.setValue(second.getValue() - diff2);
							}
						} else if (total < 100) {
							int diff1 = Math.min(100 - total, 100 - first
									.getValue());
							first.setValue(first.getValue() + diff1);
							int diff2 = 100 - total - diff1;
							if (diff2 > 0) {
								second.setValue(second.getValue() + diff2);
							}
						}
					}
				});
			}
		};
	}

	public SessionParameters getSessionParameters() {
		return new SessionParameters(dictionary, ((Boolean) languageButtonGroup
				.getCurrentValue()).booleanValue(), questionCountField
				.getValue(), randomCountField.getValue(), badCountField
				.getValue(), recentCountField.getValue());
	}

	public static SessionParameters showSessionParametersDialog(JFrame frame,
			String title, TwoWayDictionary dictionary) {
		if (panel == null) {
			panel = new SessionParametersPanel(dictionary);
		}
		int action = JOptionPane.showConfirmDialog(frame, panel,
				"Paramètres de session", JOptionPane.OK_CANCEL_OPTION);
		if (action == JOptionPane.OK_OPTION) {
			return panel.getSessionParameters();
		} else {
			return null;
		}
	}
}